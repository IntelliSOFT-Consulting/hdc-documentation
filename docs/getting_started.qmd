---
title: "Getting Started"
description: "Complete developer guide for setting up the MamaToto HIE system with Google Cloud deployment"
format: html
---

# Getting Started with MamaToto HIE

Welcome to the MamaToto Health Information Exchange (HIE) platform! This comprehensive guide will walk you through setting up a complete development and production environment, from Google Cloud infrastructure to local development.

## Overview

The MamaToto HIE is a maternal healthcare platform that enables WhatsApp-based beneficiary enrollment with standards-based FHIR and OpenHIE architecture. This system facilitates secure data exchange between healthcare providers, patients, and payment systems.

### System Architecture

```{mermaid}
%%| fig-width: 12
%%| fig-height: 10
graph TB
    subgraph "Google Cloud Platform"
        subgraph "Production VM (Ubuntu 22.04)"
            subgraph "Docker Containers"
                NGINX[Nginx Proxy<br/>:80, :443]
                OHIM_CORE[OpenHIM Core<br/>:8080, :8443]
                OHIM_CONSOLE[OpenHIM Console<br/>:9000]
                FHIR[HAPI FHIR Server<br/>:8082]
                KC[Keycloak<br/>:8180]
                WM[WhatsApp Mediator<br/>:3001]
                CM[Carepay Mediator<br/>:3002]
                FM[FHIR Mediator<br/>:3003]
            end
            
            subgraph "Databases"
                MONGO[(MongoDB<br/>OpenHIM Data)]
                POSTGRES_FHIR[(PostgreSQL<br/>FHIR Data)]
                POSTGRES_KC[(PostgreSQL<br/>Keycloak Data)]
            end
        end
        
        subgraph "External Integrations"
            WA_API[WhatsApp Business API]
            CP_API[Carepay API]
            GCP_LB[Google Cloud<br/>Load Balancer]
        end
    end
    
    subgraph "External Users"
        PATIENTS[Pregnant Mothers<br/>WhatsApp Users]
        PROVIDERS[Healthcare Providers<br/>Web Interface]
        ADMINS[System Administrators<br/>OpenHIM Console]
    end
    
    PATIENTS --> WA_API
    WA_API --> GCP_LB
    GCP_LB --> NGINX
    
    PROVIDERS --> GCP_LB
    ADMINS --> GCP_LB
    
    NGINX --> OHIM_CORE
    NGINX --> OHIM_CONSOLE
    NGINX --> FHIR
    NGINX --> KC
    
    OHIM_CORE --> WM
    OHIM_CORE --> CM
    OHIM_CORE --> FM
    
    WM --> WA_API
    CM --> CP_API
    FM --> FHIR
    
    OHIM_CORE --> MONGO
    FHIR --> POSTGRES_FHIR
    KC --> POSTGRES_KC
    
    classDef gcp fill:#4285f4,color:white
    classDef container fill:#0066cc,color:white
    classDef database fill:#ff9900,color:white
    classDef external fill:#34a853,color:white
    classDef user fill:#ea4335,color:white
    
    class GCP_LB,WA_API,CP_API gcp
    class NGINX,OHIM_CORE,OHIM_CONSOLE,FHIR,KC,WM,CM,FM container
    class MONGO,POSTGRES_FHIR,POSTGRES_KC database
    class PATIENTS,PROVIDERS,ADMINS user
```

## Part 1: Google Cloud Virtual Machine Setup

### 1.1 VM Creation and Configuration

Our production environment runs on Google Cloud Platform using a custom-configured Ubuntu 22.04 virtual machine with Docker containers orchestrated by Instant OpenHIE v2.

#### VM Specifications

```{mermaid}
%%| fig-width: 10
%%| fig-height: 6
graph LR
    subgraph "GCP VM Configuration"
        subgraph "Compute Engine"
            CPU[4 vCPUs<br/>Intel Skylake]
            RAM[16 GB RAM]
            DISK[100 GB SSD<br/>Persistent Disk]
        end
        
        subgraph "Network Configuration"
            VPC[Custom VPC<br/>mamatoto-network]
            FIREWALL[Firewall Rules<br/>HTTP/HTTPS/SSH]
            IP[Static External IP<br/>mamatoto-hie-ip]
        end
        
        subgraph "Security"
            SA[Service Account<br/>mamatoto-hie-sa]
            IAM[IAM Roles<br/>Compute Admin]
            SSH_KEYS[SSH Key Pairs<br/>Team Access]
        end
    end
    
    classDef compute fill:#4285f4,color:white
    classDef network fill:#34a853,color:white
    classDef security fill:#ea4335,color:white
    
    class CPU,RAM,DISK compute
    class VPC,FIREWALL,IP network
    class SA,IAM,SSH_KEYS security
```

#### Step-by-Step VM Creation

**1. Create the VM Instance:**

```bash
# Set project and zone variables
export PROJECT_ID="mamatoto-hie-project"
export ZONE="us-central1-a"
export VM_NAME="mamatoto-hie-vm"

# Create the VM with optimal configuration
gcloud compute instances create $VM_NAME \
    --project=$PROJECT_ID \
    --zone=$ZONE \
    --machine-type=e2-standard-4 \
    --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default \
    --maintenance-policy=MIGRATE \
    --provisioning-model=STANDARD \
    --service-account=mamatoto-hie-sa@$PROJECT_ID.iam.gserviceaccount.com \
    --scopes=https://www.googleapis.com/auth/cloud-platform \
    --create-disk=auto-delete=yes,boot=yes,device-name=$VM_NAME,image=projects/ubuntu-os-cloud/global/images/ubuntu-2204-jammy-v20240319,mode=rw,size=100,type=projects/$PROJECT_ID/zones/$ZONE/diskTypes/pd-ssd \
    --no-shielded-secure-boot \
    --shielded-vtpm \
    --shielded-integrity-monitoring \
    --labels=environment=production,project=mamatoto-hie,team=pharmaccess \
    --reservation-affinity=any
```

**2. Configure Firewall Rules:**

```bash
# Allow HTTP and HTTPS traffic
gcloud compute firewall-rules create mamatoto-hie-web \
    --project=$PROJECT_ID \
    --direction=INGRESS \
    --priority=1000 \
    --network=default \
    --action=ALLOW \
    --rules=tcp:80,tcp:443,tcp:8080,tcp:8443,tcp:9000 \
    --source-ranges=0.0.0.0/0 \
    --target-tags=mamatoto-hie

# Allow SSH access for development team
gcloud compute firewall-rules create mamatoto-hie-ssh \
    --project=$PROJECT_ID \
    --direction=INGRESS \
    --priority=1000 \
    --network=default \
    --action=ALLOW \
    --rules=tcp:22 \
    --source-ranges=0.0.0.0/0 \
    --target-tags=mamatoto-hie-ssh

# Apply tags to the VM
gcloud compute instances add-tags $VM_NAME \
    --project=$PROJECT_ID \
    --zone=$ZONE \
    --tags=mamatoto-hie,mamatoto-hie-ssh
```

**3. Reserve Static IP Address:**

```bash
# Reserve a static external IP
gcloud compute addresses create mamatoto-hie-ip \
    --project=$PROJECT_ID \
    --region=us-central1

# Get the reserved IP address
export STATIC_IP=$(gcloud compute addresses describe mamatoto-hie-ip \
    --region=us-central1 \
    --format="get(address)")

# Assign the static IP to the VM
gcloud compute instances delete-access-config $VM_NAME \
    --project=$PROJECT_ID \
    --zone=$ZONE \
    --access-config-name="External NAT"

gcloud compute instances add-access-config $VM_NAME \
    --project=$PROJECT_ID \
    --zone=$ZONE \
    --access-config-name="External NAT" \
    --address=$STATIC_IP
```

### 1.2 VM Initial Setup and Security Hardening

Once the VM is created, connect via SSH and perform initial setup:

```bash
# Connect to the VM
gcloud compute ssh $VM_NAME --project=$PROJECT_ID --zone=$ZONE

# Update the system
sudo apt update && sudo apt upgrade -y

# Install essential packages
sudo apt install -y curl wget git vim htop unzip software-properties-common apt-transport-https ca-certificates gnupg lsb-release

# Configure automatic security updates
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades

# Set up firewall
sudo ufw enable
sudo ufw allow OpenSSH
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8080/tcp
sudo ufw allow 8443/tcp
sudo ufw allow 9000/tcp

# Create application user
sudo useradd -m -s /bin/bash mamatoto
sudo usermod -aG docker mamatoto
sudo usermod -aG sudo mamatoto

# Set up SSH key authentication for the application user
sudo mkdir -p /home/mamatoto/.ssh
sudo cp ~/.ssh/authorized_keys /home/mamatoto/.ssh/
sudo chown -R mamatoto:mamatoto /home/mamatoto/.ssh
sudo chmod 700 /home/mamatoto/.ssh
sudo chmod 600 /home/mamatoto/.ssh/authorized_keys
```

### 1.3 Domain Configuration and SSL Setup

Configure your domain to point to the static IP address:

```bash
# DNS Configuration (update your DNS provider)
# A Record: mamatoto.yourdomain.com -> YOUR_STATIC_IP
# A Record: *.mamatoto.yourdomain.com -> YOUR_STATIC_IP

# Example DNS records:
# mamatoto.pharmaccess.org          IN A    34.123.45.67
# openhim.mamatoto.pharmaccess.org  IN A    34.123.45.67
# fhir.mamatoto.pharmaccess.org     IN A    34.123.45.67
# keycloak.mamatoto.pharmaccess.org IN A    34.123.45.67
```

## Part 2: Development Environment Setup

### 2.1 Prerequisites Installation

Install the required tools for local development and deployment:

**Docker Installation:**

```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Add current user to docker group
sudo usermod -aG docker $USER

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Verify installation
docker --version
docker-compose --version
```

**Instant OpenHIE v2 CLI Installation:**

```bash
# Install Node.js 18 (required for Instant v2)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install Instant OpenHIE v2 CLI globally
sudo npm install -g @jembi/instantohie

# Verify installation
instant --version

# Initialize Instant OpenHIE (creates ~/.instant directory)
instant init
```

### 2.2 Repository Setup and Configuration

**Clone and Configure the HIE Repository:**

```bash
# Clone the repository
git clone https://github.com/PharmAccess/MamaToto-HIE.git
cd MamaToto-HIE

# Create environment configuration from template
cp .env.example .env

# Edit the environment file with your specific configuration
nano .env
```

**Environment Configuration (`.env` file):**

```bash
# ========================
# MAMATOTO HIE CONFIGURATION
# ========================

# Domain Configuration
DOMAIN_NAME=mamatoto.pharmaccess.org
FHIR_SERVER_URL=https://fhir.mamatoto.pharmaccess.org/fhir
OPENHIM_CORE_URL=https://openhim.mamatoto.pharmaccess.org
KEYCLOAK_URL=https://keycloak.mamatoto.pharmaccess.org

# Database Configuration
POSTGRES_USER=mamatoto_user
POSTGRES_PASSWORD=SecurePassword123!
POSTGRES_DB=mamatoto_hie
MONGO_INITDB_ROOT_USERNAME=mongo_admin
MONGO_INITDB_ROOT_PASSWORD=MongoSecure456!

# OpenHIM Configuration
OPENHIM_ROOT_EMAIL=admin@pharmaccess.org
OPENHIM_ROOT_PASSWORD=AdminPassword789!
OPENHIM_MONGO_URL=mongodb://mongo_admin:MongoSecure456!@mongo:27017/openhim?authSource=admin

# Keycloak Configuration
KEYCLOAK_ADMIN=admin
KEYCLOAK_ADMIN_PASSWORD=KeycloakAdmin123!
KC_DB_URL=jdbc:postgresql://postgres-keycloak:5432/keycloak
KC_DB_USERNAME=keycloak_user
KC_DB_PASSWORD=KeycloakDB456!

# FHIR Server Configuration
HAPI_FHIR_DATASOURCE_URL=jdbc:postgresql://postgres-fhir:5432/fhir
HAPI_FHIR_DATASOURCE_USERNAME=fhir_user
HAPI_FHIR_DATASOURCE_PASSWORD=FhirDB789!

# WhatsApp Integration
WHATSAPP_API_URL=https://graph.facebook.com/v18.0
WHATSAPP_ACCESS_TOKEN=your_whatsapp_access_token
WHATSAPP_VERIFY_TOKEN=your_whatsapp_verify_token
WHATSAPP_WEBHOOK_URL=https://mamatoto.pharmaccess.org/whatsapp/webhook

# Carepay Integration
CAREPAY_API_URL=https://api.carepay.com/v1
CAREPAY_API_KEY=your_carepay_api_key
CAREPAY_CLIENT_ID=your_carepay_client_id
CAREPAY_CLIENT_SECRET=your_carepay_client_secret

# SSL Configuration
SSL_CERT_PATH=/opt/ssl/certs
SSL_KEY_PATH=/opt/ssl/private
SSL_CA_PATH=/opt/ssl/ca

# Logging Configuration
LOG_LEVEL=info
LOG_FORMAT=json
```

## Part 3: Understanding the Mediators

Mediators are the core integration components that handle communication between different systems in the MamaToto HIE. Each mediator serves a specific purpose and follows the OpenHIM mediator pattern.

### 3.1 Mediator Architecture Overview

```{mermaid}
graph TB
    subgraph "Mediator Layer Architecture"
        subgraph "Incoming Requests"
            WA_REQ[WhatsApp Webhook]
            API_REQ[REST API Calls]
            FHIR_REQ[FHIR Operations]
        end
        
        subgraph "OpenHIM Core"
            ROUTER[Request Router]
            AUTH[Authentication]
            AUDIT[Audit Logging]
        end
        
        subgraph "Mediators"
            WM[WhatsApp Mediator<br/>Message Processing]
            CM[Carepay Mediator<br/>Payment Integration]
            FM[FHIR Mediator<br/>Data Validation]
            AM[Auth Mediator<br/>Token Management]
            NM[Notification Mediator<br/>Multi-channel Alerts]
        end
        
        subgraph "Target Systems"
            WA_API[WhatsApp Business API]
            CP_SYS[Carepay System]
            FHIR_SRV[FHIR Server]
            KC_SRV[Keycloak]
            SMS_GW[SMS Gateway]
        end
    end
    
    WA_REQ --> ROUTER
    API_REQ --> ROUTER
    FHIR_REQ --> ROUTER
    
    ROUTER --> AUTH
    AUTH --> AUDIT
    
    AUDIT --> WM
    AUDIT --> CM
    AUDIT --> FM
    AUDIT --> AM
    AUDIT --> NM
    
    WM --> WA_API
    CM --> CP_SYS
    FM --> FHIR_SRV
    AM --> KC_SRV
    NM --> SMS_GW
    NM --> WA_API
    
    classDef request fill:#e3f2fd
    classDef core fill:#e8f5e8
    classDef mediator fill:#fff3e0
    classDef target fill:#f3e5f5
    
    class WA_REQ,API_REQ,FHIR_REQ request
    class ROUTER,AUTH,AUDIT core
    class WM,CM,FM,AM,NM mediator
    class WA_API,CP_SYS,FHIR_SRV,KC_SRV,SMS_GW target
```

### 3.2 WhatsApp Mediator - Message Processing Engine

The WhatsApp Mediator handles all WhatsApp Business API interactions for the maternal health enrollment workflow.

**Key Capabilities:**
- **Webhook Processing**: Receives and validates WhatsApp webhook events
- **Conversation Management**: Maintains conversation state and context
- **Message Routing**: Routes different message types to appropriate handlers
- **Consent Framework**: Manages user consent collection and validation
- **Language Support**: Multi-language message templates and responses

**Message Flow Architecture:**

```{mermaid}
sequenceDiagram
    participant User as Pregnant Mother
    participant WA as WhatsApp API
    participant WM as WhatsApp Mediator
    participant CF as Consent Framework
    participant FHIR as FHIR Server
    participant CP as Carepay System
    
    User->>WA: "Hi, I want to enroll"
    WA->>WM: Webhook: message received
    
    Note over WM: Parse message intent
    
    WM->>CF: Check consent status
    CF-->>WM: No consent found
    
    WM->>WA: Send consent request
    WA-->>User: "Do you consent to data processing?"
    
    User->>WA: "Yes, I consent"
    WA->>WM: Webhook: consent received
    
    WM->>CF: Record consent
    CF-->>WM: Consent recorded
    
    WM->>WA: Send enrollment form
    WA-->>User: "Please provide your details..."
    
    User->>WA: Provides personal information
    WA->>WM: Webhook: form data received
    
    Note over WM: Validate and structure data
    
    WM->>FHIR: Create Patient resource
    FHIR-->>WM: Patient created
    
    WM->>CP: Create payment profile
    CP-->>WM: Profile created
    
    WM->>WA: Send confirmation
    WA-->>User: "Enrollment successful!"
```

**Consent Framework Implementation:**

The consent framework ensures GDPR and healthcare data compliance:

```javascript
// Consent Framework Structure
const consentFramework = {
  consentTypes: {
    DATA_PROCESSING: 'data_processing',
    MEDICAL_CARE: 'medical_care', 
    PAYMENT_PROCESSING: 'payment_processing',
    COMMUNICATION: 'communication'
  },
  
  consentStatus: {
    PENDING: 'pending',
    GRANTED: 'granted',
    DENIED: 'denied',
    WITHDRAWN: 'withdrawn'
  },
  
  requiredConsents: [
    'DATA_PROCESSING',
    'MEDICAL_CARE',
    'PAYMENT_PROCESSING'
  ],
  
  optionalConsents: [
    'COMMUNICATION'
  ]
}
```

### 3.3 Carepay Mediator - Payment Integration Hub

The Carepay Mediator manages all financial transactions and payment-related operations.

**Core Functions:**
- **Subscriber Management**: Creates and manages patient payment profiles
- **Transaction Processing**: Handles payment transactions and claims
- **Wallet Operations**: Manages digital wallet balance and transactions
- **Claims Processing**: Submits and tracks healthcare claims
- **Reporting**: Generates financial reports and analytics

**Payment Integration Flow:**

```{mermaid}
graph LR
    subgraph "Payment Workflow"
        subgraph "Enrollment Phase"
            E1[Patient Enrollment]
            E2[Create Carepay Profile]
            E3[Link to FHIR Patient]
        end
        
        subgraph "Service Delivery"
            S1[Healthcare Service]
            S2[Generate Claim]
            S3[Process Payment]
        end
        
        subgraph "Financial Management"
            F1[Wallet Balance Check]
            F2[Transaction Logging]
            F3[Financial Reporting]
        end
    end
    
    E1 --> E2
    E2 --> E3
    E3 --> S1
    S1 --> S2
    S2 --> F1
    F1 --> S3
    S3 --> F2
    F2 --> F3
    
    classDef enroll fill:#e8f5e8
    classDef service fill:#fff3e0
    classDef finance fill:#f3e5f5
    
    class E1,E2,E3 enroll
    class S1,S2,S3 service
    class F1,F2,F3 finance
```

### 3.4 FHIR Mediator - Data Validation and Transformation

The FHIR Mediator ensures all healthcare data meets FHIR R4 standards and maintains data quality.

**Primary Responsibilities:**
- **Data Validation**: Validates all FHIR resources against profiles
- **Data Transformation**: Converts between different data formats
- **Resource Relationships**: Maintains referential integrity between resources
- **Search Optimization**: Optimizes FHIR search queries
- **Audit Logging**: Tracks all data access and modifications

### 3.5 Authentication Mediator - Security and Access Control

Manages JWT tokens, session validation, and access control across all HIE components.

### 3.6 Notification Mediator - Multi-Channel Communication

Handles SMS notifications, email alerts, and WhatsApp messages for various system events.

## Part 4: System Deployment

### 4.1 Production Deployment

Deploy the complete system using Instant OpenHIE v2:

```bash
# Switch to the mamatoto user
sudo su - mamatoto

# Navigate to the project directory
cd /home/mamatoto/MamaToto-HIE

# Start the complete HIE stack
instant package up -p mamatoto --env-file .env

# Verify all services are running
docker ps

# Check service health
instant package ps -p mamatoto
```

### 4.2 Service Verification

**Health Check Script:**

```bash
#!/bin/bash
# health-check.sh - Verify all services are operational

echo "=== MamaToto HIE Health Check ==="
echo "Timestamp: $(date)"
echo ""

# Function to check HTTP endpoint
check_endpoint() {
    local name=$1
    local url=$2
    local expected_code=${3:-200}
    
    echo -n "Checking $name... "
    response=$(curl -s -o /dev/null -w "%{http_code}" "$url" --max-time 10)
    
    if [ "$response" -eq "$expected_code" ]; then
        echo "‚úÖ OK ($response)"
    else
        echo "‚ùå FAIL ($response)"
    fi
}

# Check all services
check_endpoint "Nginx Proxy" "http://localhost"
check_endpoint "OpenHIM Core" "http://localhost:8080/heartbeat"
check_endpoint "OpenHIM Console" "http://localhost:9000"
check_endpoint "FHIR Server" "http://localhost:8082/fhir/metadata"
check_endpoint "Keycloak" "http://localhost:8180/auth/realms/mamatoto"

# Check databases
echo ""
echo "=== Database Connectivity ==="
docker exec -t mamatoto_mongo_1 mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "MongoDB: ‚úÖ Connected"
else
    echo "MongoDB: ‚ùå Connection failed"
fi

docker exec -t mamatoto_postgres-fhir_1 pg_isready > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "PostgreSQL (FHIR): ‚úÖ Connected"
else
    echo "PostgreSQL (FHIR): ‚ùå Connection failed"
fi

docker exec -t mamatoto_postgres-keycloak_1 pg_isready > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "PostgreSQL (Keycloak): ‚úÖ Connected"
else
    echo "PostgreSQL (Keycloak): ‚ùå Connection failed"
fi

echo ""
echo "=== System Resources ==="
echo "CPU Usage: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')%"
echo "Memory Usage: $(free | grep Mem | awk '{printf("%.1f%%"), $3/$2 * 100.0}')"
echo "Disk Usage: $(df -h / | awk 'NR==2{printf "%s", $5}')"

echo ""
echo "Health check completed."
```

### 4.3 Container Management

**Useful Management Commands:**

```bash
# View logs for specific service
instant package logs -p mamatoto --service openhim-core

# Restart specific service
instant package restart -p mamatoto --service fhir-server

# Scale a service (if supported)
docker-compose -f ~/.instant/packages/mamatoto/docker-compose.yml scale whatsapp-mediator=2

# Update a specific service
instant package pull -p mamatoto --service nginx
instant package up -p mamatoto --service nginx

# Backup databases
./scripts/backup-databases.sh

# Stop all services
instant package down -p mamatoto

# Stop and remove all data (DESTRUCTIVE)
instant package down -p mamatoto -v
```

## Part 5: Comprehensive Troubleshooting Guide

### 5.1 Common Deployment Issues

#### Issue: Container Start Failures

**Symptoms:**
- Containers exit immediately after starting
- "Port already in use" errors
- Database connection failures

**Diagnosis Commands:**
```bash
# Check container status
docker ps -a

# View container logs
docker logs <container_name>

# Check port usage
netstat -tulpn | grep :8080

# Check available resources
docker system df
free -h
df -h
```

**Solutions:**

1. **Port Conflicts:**
```bash
# Find process using the port
sudo lsof -i :8080

# Kill the conflicting process
sudo kill -9 <PID>

# Or change the port in .env file
echo "OPENHIM_CORE_HTTP_PORT=8081" >> .env
```

2. **Insufficient Resources:**
```bash
# Check Docker resource limits
docker system info

# Increase VM resources in GCP Console
# Or add swap space
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

3. **Database Initialization Issues:**
```bash
# Reset database volumes
docker volume ls | grep mamatoto
docker volume rm mamatoto_mongo_data mamatoto_postgres_data

# Restart with fresh databases
instant package up -p mamatoto
```

#### Issue: SSL/TLS Certificate Problems

**Symptoms:**
- Browser security warnings
- SSL handshake failures
- Certificate verification errors

**Diagnosis:**
```bash
# Check certificate validity
openssl x509 -in /opt/ssl/certs/mamatoto.crt -text -noout

# Test SSL connection
openssl s_client -connect mamatoto.pharmaccess.org:443 -servername mamatoto.pharmaccess.org

# Check certificate chain
curl -I https://mamatoto.pharmaccess.org
```

**Solutions:**

1. **Generate New Certificates:**
```bash
# Run the SSL setup script
./scripts/ssl-setup.sh

# Or use Let's Encrypt
sudo apt install certbot
sudo certbot certonly --standalone -d mamatoto.pharmaccess.org
```

2. **Update Certificate Paths:**
```bash
# Update nginx configuration
nano /opt/ssl/nginx/default.conf

# Restart nginx
docker restart mamatoto_nginx_1
```

### 5.2 Integration Issues

#### Issue: WhatsApp Webhook Not Receiving Messages

**Symptoms:**
- WhatsApp messages not triggering webhook
- 404 errors in webhook logs
- Webhook verification failures

**Diagnosis:**
```bash
# Check webhook endpoint
curl -X GET "https://mamatoto.pharmaccess.org/whatsapp/webhook?hub.verify_token=your_verify_token&hub.challenge=challenge_string"

# Check mediator logs
docker logs mamatoto_whatsapp-mediator_1 -f

# Test local connectivity
curl -X POST http://localhost:3001/webhook -H "Content-Type: application/json" -d '{"test": "message"}'
```

**Solutions:**

1. **Verify Webhook Configuration:**
```bash
# Update WhatsApp webhook URL in Facebook Developer Console
# URL: https://mamatoto.pharmaccess.org/whatsapp/webhook
# Verify Token: (from .env file)
```

2. **Fix Firewall Issues:**
```bash
# Ensure firewall allows webhook traffic
sudo ufw allow 443/tcp
sudo ufw status

# Check GCP firewall rules
gcloud compute firewall-rules list --filter="name:mamatoto"
```

#### Issue: FHIR Server Connection Failures

**Symptoms:**
- FHIR operations return 500 errors
- Database connection timeouts
- Resource validation failures

**Diagnosis:**
```bash
# Check FHIR server health
curl http://localhost:8082/fhir/metadata

# Check database connectivity
docker exec -it mamatoto_postgres-fhir_1 psql -U fhir_user -d fhir -c "SELECT version();"

# Check FHIR logs
docker logs mamatoto_fhir-server_1 --tail 100
```

**Solutions:**

1. **Database Connection Issues:**
```bash
# Restart PostgreSQL
docker restart mamatoto_postgres-fhir_1

# Reset FHIR database
docker exec -it mamatoto_postgres-fhir_1 psql -U postgres -c "DROP DATABASE fhir; CREATE DATABASE fhir OWNER fhir_user;"
docker restart mamatoto_fhir-server_1
```

2. **FHIR Validation Issues:**
```bash
# Check FHIR structure definitions
curl http://localhost:8082/fhir/StructureDefinition

# Validate a specific resource
curl -X POST http://localhost:8082/fhir/Patient/\$validate -H "Content-Type: application/json" -d @patient-example.json
```

### 5.3 Performance Optimization

#### Monitoring Commands

```bash
# Monitor container resource usage
docker stats

# Check system performance
htop
iotop
iostat -x 1

# Monitor network connections
netstat -an | grep ESTABLISHED | wc -l

# Check database performance
docker exec -it mamatoto_postgres-fhir_1 psql -U fhir_user -d fhir -c "SELECT * FROM pg_stat_activity;"
```

#### Optimization Strategies

1. **Database Tuning:**
```sql
-- PostgreSQL performance tuning
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
SELECT pg_reload_conf();
```

2. **Container Resource Limits:**
```yaml
# docker-compose override
version: '3.8'
services:
  fhir-server:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
```

### 5.4 Backup and Recovery

#### Automated Backup Script

```bash
#!/bin/bash
# backup-system.sh - Complete system backup

BACKUP_DIR="/opt/backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

echo "Starting MamaToto HIE backup..."

# Backup databases
echo "Backing up MongoDB..."
docker exec mamatoto_mongo_1 mongodump --out /tmp/backup
docker cp mamatoto_mongo_1:/tmp/backup $BACKUP_DIR/mongodb

echo "Backing up PostgreSQL (FHIR)..."
docker exec mamatoto_postgres-fhir_1 pg_dump -U fhir_user fhir > $BACKUP_DIR/fhir-db.sql

echo "Backing up PostgreSQL (Keycloak)..."
docker exec mamatoto_postgres-keycloak_1 pg_dump -U keycloak_user keycloak > $BACKUP_DIR/keycloak-db.sql

# Backup configurations
echo "Backing up configurations..."
cp -r ~/.instant/packages/mamatoto $BACKUP_DIR/config
cp .env $BACKUP_DIR/env-config

# Backup SSL certificates
echo "Backing up SSL certificates..."
cp -r /opt/ssl $BACKUP_DIR/ssl

# Create archive
echo "Creating backup archive..."
tar -czf $BACKUP_DIR.tar.gz -C $(dirname $BACKUP_DIR) $(basename $BACKUP_DIR)
rm -rf $BACKUP_DIR

echo "Backup completed: $BACKUP_DIR.tar.gz"

# Cleanup old backups (keep last 7 days)
find /opt/backups -name "*.tar.gz" -mtime +7 -delete

# Upload to Google Cloud Storage (optional)
# gsutil cp $BACKUP_DIR.tar.gz gs://mamatoto-backups/
```

## Part 6: Maintenance and Monitoring

### 6.1 System Monitoring Dashboard

Create a simple monitoring script to track system health:

```bash
#!/bin/bash
# monitor.sh - System monitoring dashboard

while true; do
    clear
    echo "=================================================="
    echo "MamaToto HIE System Monitor - $(date)"
    echo "=================================================="
    echo ""
    
    # Container Status
    echo "üì¶ Container Status:"
    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep mamatoto
    echo ""
    
    # Resource Usage
    echo "üíª System Resources:"
    echo "CPU: $(grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {print usage "%"}')"
    echo "Memory: $(free | grep Mem | awk '{printf("%.1f%%"), $3/$2 * 100.0}')"
    echo "Disk: $(df -h / | awk 'NR==2{printf "%s", $5}')"
    echo ""
    
    # Network Connections
    echo "üåê Active Connections:"
    echo "Total: $(netstat -an | grep ESTABLISHED | wc -l)"
    echo "Port 443: $(netstat -an | grep :443 | grep ESTABLISHED | wc -l)"
    echo "Port 8080: $(netstat -an | grep :8080 | grep ESTABLISHED | wc -l)"
    echo ""
    
    # Recent Logs (last 5 minutes)
    echo "üìã Recent Activity:"
    docker logs mamatoto_openhim-core_1 --since=5m --tail=5 2>/dev/null | tail -3
    echo ""
    
    echo "Press Ctrl+C to exit"
    sleep 30
done
```

### 6.2 Automated Health Checks

Set up automated health checks with email notifications:

```bash
#!/bin/bash
# health-monitor.sh - Automated health monitoring with alerts

EMAIL="admin@pharmaccess.org"
WEBHOOK_URL="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

check_service() {
    local service_name=$1
    local check_url=$2
    local expected_code=${3:-200}
    
    response=$(curl -s -o /dev/null -w "%{http_code}" "$check_url" --max-time 10)
    
    if [ "$response" -ne "$expected_code" ]; then
        send_alert "$service_name" "$check_url" "$response"
        return 1
    fi
    return 0
}

send_alert() {
    local service=$1
    local url=$2
    local code=$3
    
    message="üö® ALERT: $service is down (HTTP $code) - $url"
    
    # Send email
    echo "$message" | mail -s "MamaToto HIE Alert" "$EMAIL"
    
    # Send Slack notification
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"$message\"}" \
        "$WEBHOOK_URL"
    
    # Log to syslog
    logger -t mamatoto-monitor "$message"
}

# Run health checks
check_service "OpenHIM Core" "http://localhost:8080/heartbeat"
check_service "FHIR Server" "http://localhost:8082/fhir/metadata"
check_service "Keycloak" "http://localhost:8180/auth/realms/mamatoto"
```

### 6.3 Log Management

Configure log rotation and management:

```bash
# /etc/logrotate.d/docker-containers
/var/lib/docker/containers/*/*.log {
    rotate 7
    daily
    compress
    size 10M
    missingok
    delaycompress
    copytruncate
}
```

## Conclusion

This comprehensive getting started guide provides everything needed to set up, deploy, and maintain the MamaToto HIE system. The combination of detailed setup instructions, visual architecture diagrams, troubleshooting procedures, and maintenance scripts ensures that new developers can quickly understand and work with the system.

### Quick Reference Commands

```bash
# Start the system
instant package up -p mamatoto

# Check system health
./scripts/health-check.sh

# View logs
instant package logs -p mamatoto --service openhim-core

# Backup system
./scripts/backup-system.sh

# Stop the system
instant package down -p mamatoto
```

### Next Steps

1. **Review the architecture documentation** in the Architecture section
2. **Explore individual mediator details** in the Mediators section  
3. **Configure SSL certificates** using the SSL/TLS Management guide
4. **Set up monitoring** using the provided scripts
5. **Join the development team** communication channels for support

For additional support, consult the detailed documentation sections or contact the PharmAccess development team.

